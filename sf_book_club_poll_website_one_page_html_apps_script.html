<!--
SF Book Club – One‑Page Poll Site
Modern, bookish vibe • Anonymous by default • Suggestions field • Optional name
HOST on GitHub Pages/Netlify. BACKEND via Google Apps Script bound to your Sheet.

==================== HOW TO SET UP (read then delete this comment if you like) ====================
1) Make a Google Sheet named: SF Book Club 4.0 Poll Responses
   Create (or keep) a first sheet/tab called: Responses (exactly this)
   Add headers in row 1: Timestamp | Book Choice | Suggestion | Name

2) In that Sheet, go to Extensions ▸ Apps Script.
   - Paste the Apps Script code from the bottom of this file into Code.gs, save.
   - Deploy ▸ New deployment ▸ Type: Web app
       * Description: SFBC Poll API
       * Execute as: Me
       * Who has access: Anyone
     Click Deploy and copy the Web app URL. This is your SCRIPT_URL.

3) In this HTML file, paste your SCRIPT_URL into the placeholder below.
   Deploy this file to Netlify (drag‑and‑drop) or GitHub Pages.

4) Test once. Submissions will appear in your Sheet under the “Responses” tab.
===============================================================================================
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SF Book Club 4.0 — Poll</title>
  <meta name="description" content="Vote for the next SF Book Club read and suggest your own pick (anonymous by default)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Literata:opsz,wght@7..72,500;7..72,700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0e0f12; /* charcoal */
      --card:#14161b; /* deep graphite */
      --ink:#e8ebf1; /* soft white */
      --muted:#a9b0c3; /* slate */
      --accent:#c5a572; /* bookish gold */
      --accent-ink:#0b0c0f;
      --ring: 2px solid rgba(197,165,114,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 700px at 80% -10%, rgba(197,165,114,.08), transparent 60%),
                                 radial-gradient(900px 500px at 0% 100%, rgba(197,165,114,.06), transparent 60%),
                                 var(--bg);
      color:var(--ink); font: 16px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    header{
      max-width: 860px; margin: 32px auto 16px; padding: 0 20px;
    }
    .title{display:flex; gap:12px; align-items:center}
    .logo{
      width:44px; height:44px; border-radius:12px; background:
        linear-gradient(135deg, rgba(197,165,114,.25), rgba(197,165,114,.05)),
        radial-gradient(70% 80% at 50% 10%, rgba(197,165,114,.55), rgba(197,165,114,.15) 60%, transparent 61%),
        var(--card);
      display:grid; place-items:center; box-shadow: 0 6px 18px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .logo span{font-family: Literata, Georgia, serif; font-size:24px}
    h1{font: 700 28px/1.1 Literata, Georgia, serif; margin:0}
    .sub{color:var(--muted); margin-top:6px}

    .card{ max-width: 860px; margin: 16px auto; padding: 24px; border-radius: 20px; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card);
           box-shadow: 0 16px 40px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .row{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width:720px){ .row{ grid-template-columns: 1fr 1fr; } }

    .group{ padding:16px 18px; border-radius:16px; background: rgba(255,255,255,.02); border: 1px solid rgba(255,255,255,.06); }
    .group h3{ margin:0 0 12px; font:600 14px/1 Inter, system-ui; letter-spacing:.02em; color:var(--muted); text-transform:uppercase }

    .options{ display:grid; gap:10px }
    label.option{ display:flex; gap:12px; align-items:flex-start; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.07); background: rgba(0,0,0,.15); cursor:pointer; }
    label.option:hover{ outline: var(--ring); }
    input[type=radio]{ margin-top:3px; accent-color: var(--accent); }
    .book-title{ font-weight:600 }
    .genre{ color:var(--muted); font-size:13px }

    textarea, input[type=text]{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.04); color:var(--ink); }
    textarea:focus, input[type=text]:focus{ outline: var(--ring); }

    .hint{ color:var(--muted); font-size:13px; margin-top:8px }

    .flex{ display:flex; align-items:center; gap:10px }
    .switch{ position:relative; width:42px; height:24px; background:rgba(255,255,255,.15); border-radius:999px; transition:.2s; cursor:pointer; }
    .switch::after{ content:""; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition:.2s; }
    input#nameToggle:checked + .switch{ background: var(--accent); }
    input#nameToggle:checked + .switch::after{ left:21px; }
    input#nameToggle{ display:none }

    .actions{ display:flex; gap:12px; align-items:center; justify-content:flex-start; margin-top:18px }
    button.primary{ appearance:none; border:0; padding:12px 18px; border-radius:12px; font-weight:600; background: linear-gradient(180deg, #e9cf9e, #c5a572); color:var(--accent-ink); box-shadow: 0 10px 22px rgba(197,165,114,.25), inset 0 0 0 1px rgba(0,0,0,.12); cursor:pointer }
    button.primary:active{ transform: translateY(1px) }
    .ghost{ color:var(--muted); font-size:14px }

    .toast{ position:fixed; inset:auto 16px 16px auto; background:#101215; border:1px solid rgba(255,255,255,.08); padding:12px 14px; border-radius:12px; opacity:0; transform:translateY(8px); transition:.25s; pointer-events:none }
    .toast.show{ opacity:1; transform:translateY(0) }

    footer{ max-width: 860px; margin: 24px auto 40px; padding: 0 20px; color:var(--muted); font-size:13px }
    a{ color: var(--accent) }
      /* Results UI */
    .results{ max-width:860px; margin:16px auto; padding:24px; border-radius:20px; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card); box-shadow: 0 16px 40px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);}
    .results h2{ font:700 22px/1.2 Literata, Georgia, serif; margin:0 0 14px }
    .result-row{ margin:10px 0 }
    .bar{ height:12px; border-radius:999px; background: rgba(255,255,255,.08); overflow:hidden; }
    .bar > span{ display:block; height:100%; background: linear-gradient(180deg, #e9cf9e, #c5a572) }
    .label-line{ display:flex; justify-content:space-between; gap:12px; font-size:14px; color:var(--ink); margin-bottom:6px }
    .suggestions{ margin-top:16px; padding-top:8px; border-top:1px solid rgba(255,255,255,.08); color:var(--muted) }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div class="logo" aria-hidden="true"><span>📚</span></div>
      <div>
        <h1>SF Book Club 4.0 — Poll</h1>
        <div class="sub">As discussed: we’ll pick <strong>one book</strong> for the next meetup, and still keep the <em>favorite book</em> share for new joiners or anyone who prefers that format.</div>
      </div>
    </div>
  </header>

  <main class="card" id="formCard">
    <!-- Replace with your Apps Script Web App URL -->
    <form id="pollForm" action="https://script.google.com/macros/s/AKfycbyLC8t9XRtAjQr26gaDttkoBDYOlXexXi_ZVdS8576S-4CayozUrFCyok2WlVLPxnOasQ/exec" method="POST" target="hidden_iframe" onsubmit="return handleSubmit()">
      <div class="row">
        <section class="group">
          <h3>Vote for our next read</h3>
          <div class="options">
            <label class="option">
              <input type="radio" name="Book Choice" value="The Overstory — Nature / Literary Fiction" required>
              <div>
                <div class="book-title">The Overstory</div>
                <div class="genre">🌳 Nature / Literary Fiction — Richard Powers</div>
              </div>
            </label>
            <label class="option">
              <input type="radio" name="Book Choice" value="Maybe You Should Talk to Someone — Memoir / Psychology">
              <div>
                <div class="book-title">Maybe You Should Talk to Someone</div>
                <div class="genre">🧠 Memoir / Psychology — Lori Gottlieb</div>
              </div>
            </label>
            <label class="option">
              <input type="radio" name="Book Choice" value="Tomorrow, and Tomorrow, and Tomorrow — Fiction / Creativity">
              <div>
                <div class="book-title">Tomorrow, and Tomorrow, and Tomorrow</div>
                <div class="genre">🎮 Fiction / Creativity — Gabrielle Zevin</div>
              </div>
            </label>
            <label class="option">
              <input type="radio" name="Book Choice" value="Braiding Sweetgrass — Science / Indigenous Wisdom">
              <div>
                <div class="book-title">Braiding Sweetgrass</div>
                <div class="genre">🍃 Science / Indigenous Wisdom — Robin Wall Kimmerer</div>
              </div>
            </label>
            <label class="option">
              <input type="radio" name="Book Choice" value="Klara and the Sun — Sci‑Fi / Philosophy">
              <div>
                <div class="book-title">Klara and the Sun</div>
                <div class="genre">🤖 Sci‑Fi / Philosophy — Kazuo Ishiguro</div>
              </div>
            </label>
            <label class="option">
              <input type="radio" name="Book Choice" value="The Book of Delights — Essays / Joy & Reflection">
              <div>
                <div class="book-title">The Book of Delights</div>
                <div class="genre">🌼 Essays / Joy & Reflection — Ross Gay</div>
              </div>
            </label>
          </div>
          <p class="hint">Anonymous by default. We only record your choice—no names unless you add it below.</p>
        </section>

        <section class="group">
          <h3>Suggest a book (optional)</h3>
          <textarea name="Suggestion" rows="6" placeholder="Suggest a title/author or drop a note (anonymous by default)"></textarea>

          <div class="hint" style="margin-top:12px">Want to attach your name? Toggle below (optional).</div>
          <div class="flex" style="margin-top:8px">
            <input type="checkbox" id="nameToggle" onchange="toggleName()" aria-label="Include my name">
            <label class="switch" for="nameToggle" title="Include my name"></label>
            <input type="text" name="Name" id="nameField" placeholder="Your name (optional)" disabled>
          </div>
        </section>
      </div>

      <div class="actions">
        <button class="primary" type="submit">Submit Vote</button>
        <span class="ghost">Thank you for keeping the club awesome ✨</span>
      </div>

      <!-- Extras -->
      <input type="hidden" name="Source" value="sf_book_club_4_0">
    </form>
  </main>

  <!-- Results block (hidden until after submit or when opened with ?results=1) -->
  <section id="results" class="results" style="display:none">
    <h2>Live Results</h2>
    <div id="resultsList"></div>
    <div class="suggestions">
      <h3 style="margin:10px 0">Outside Suggestions</h3>
      <ul id="suggestionsList"></ul>
    </div>
  </section>

  <div id="toast" class="toast" role="status" aria-live="polite">Thanks! Your response has been recorded.</div>
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none" onload="showToast()"></iframe>

  <footer>
    Tip: If two books tie, we’ll run a quick tiebreaker poll in chat. 
  </footer>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyLC8t9XRtAjQr26gaDttkoBDYOlXexXi_ZVdS8576S-4CayozUrFCyok2WlVLPxnOasQ/exec';

    function toggleName(){
      const t = document.getElementById('nameToggle');
      const f = document.getElementById('nameField');
      f.disabled = !t.checked;
      if (!t.checked){ f.value = '' }
    }

    function showToast(){
      const toast = document.getElementById('toast');
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 2000);
      // After submit: reveal results
      document.getElementById('formCard').style.display = 'none';
      loadResults();
    }

    function handleSubmit(){
      const checked = document.querySelector('input[type=radio][name="Book Choice"]:checked');
      if (!checked){ alert('Please pick a book before submitting.'); return false; }
      return true;
    }

    async function loadResults(){
      try{
        const url = SCRIPT_URL + (SCRIPT_URL.includes('?') ? '&' : '?') + 'summary=1';
        const res = await fetch(url, { method:'GET' });
        const data = await res.json();
        renderResults(data);
        document.getElementById('results').style.display = 'block';
      }catch(err){
        console.error(err);
        document.getElementById('results').style.display = 'block';
        document.getElementById('resultsList').innerHTML = '<p class="hint">Could not load results right now.</p>';
      }
    }

    function renderResults(data){
      // data = { totalVotes, tallies:{label:count}, suggestions:[{text,name}] }
      const list = document.getElementById('resultsList');
      list.innerHTML = '';
      const total = data.totalVotes || 0;
      const entries = Object.entries(data.tallies || {}).sort((a,b)=> b[1]-a[1]);
      entries.forEach(([label,count])=>{
        const pct = total ? Math.round((count/total)*100) : 0;
        const row = document.createElement('div');
        row.className = 'result-row';
        row.innerHTML = `
          <div class="label-line"><span>${label}</span><span>${pct}% (${count})</span></div>
          <div class="bar"><span style="width:${pct}%"></span></div>
        `;
        list.appendChild(row);
      });

      const suggUL = document.getElementById('suggestionsList');
      suggUL.innerHTML = '';
      (data.suggestions || []).forEach(s=>{
        const li = document.createElement('li');
        const who = s.name ? ` — <em>${escapeHtml(s.name)}</em>` : '';
        li.innerHTML = `${escapeHtml(s.text)}${who}`;
        suggUL.appendChild(li);
      });
    }

    function escapeHtml(str){
      return String(str||'').replace(/[&<>"]+/g, s=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[s]));
    }

    // If page opens with ?results=1, show results immediately
    (function(){
      const params = new URLSearchParams(location.search);
      if (params.get('results') === '1'){
        document.getElementById('formCard').style.display = 'none';
        loadResults();
      }
    })();
  </script>

  <!-- ================== GOOGLE APPS SCRIPT (paste into Code.gs in the Sheet) ==================
  function doPost(e){
    try {
      var sheet = SpreadsheetApp.getActive().getSheetByName('Responses');
      if (!sheet){ sheet = SpreadsheetApp.getActive().insertSheet('Responses');
        sheet.appendRow(['Timestamp','Book Choice','Suggestion','Name']);
      }
      var p = e && e.parameter ? e.parameter : {};
      var book = p['Book Choice'] || '';
      var suggestion = p['Suggestion'] || '';
      var name = p['Name'] || '';
      sheet.appendRow([new Date(), book, suggestion, name]);
      return ContentService
        .createTextOutput(JSON.stringify({status:'ok'}))
        .setMimeType(ContentService.MimeType.JSON);
    } catch (err){
      return ContentService
        .createTextOutput(JSON.stringify({status:'error', message: String(err)}))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }

  // Add this to enable live results via GET
  function doGet(e){
    var sheet = SpreadsheetApp.getActive().getSheetByName('Responses');
    if (!sheet){
      return ContentService
        .createTextOutput(JSON.stringify({totalVotes:0, tallies:{}, suggestions:[]}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    var values = sheet.getDataRange().getValues();
    var header = values.shift();
    var idxBook = header.indexOf('Book Choice');
    var idxSuggestion = header.indexOf('Suggestion');
    var idxName = header.indexOf('Name');
    var tallies = {};
    var suggestions = [];
    var total = 0;
    values.forEach(function(row){
      var book = (row[idxBook] || '').toString().trim();
      var sugg = (row[idxSuggestion] || '').toString().trim();
      var name = (row[idxName] || '').toString().trim();
      if (book){
        tallies[book] = (tallies[book]||0) + 1;
        total++;
      }
      if (sugg){
        suggestions.push({ text: sugg, name: name });
      }
    });
    var out = { totalVotes: total, tallies: tallies, suggestions: suggestions };
    return ContentService
      .createTextOutput(JSON.stringify(out))
      .setMimeType(ContentService.MimeType.JSON);
  }
  ============================================================================================ -->
</body>
</html>
